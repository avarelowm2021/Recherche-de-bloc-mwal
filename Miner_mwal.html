<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Mineur de Blocs ‚Äì Projet LUTH</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; margin:0; padding-top:220px; }
    .form, .history { background: #222; padding: 15px; border-radius: 8px; margin:20px 0; }
    label { display: block; margin-top: 10px; }
    input, button { padding: 8px; margin-top: 5px; border: none; border-radius: 5px; }
    input { background: #333; color: #fff; width: 100%; }
    button { cursor: pointer; font-weight: bold; }
    .btn-enregistrer { background: #0f0; color: #000; width: 100%; }
    .btn-reset { background: #f00; color: #fff; margin-top: 10px; width: 100%; }
    .btn-export { background: #00f; color: #fff; margin-top: 10px; width: 100%; }
    .btn-export-pdf { background: #ff9800; color: #000; margin-top: 10px; width: 100%; }
    .contrat { border: 1px solid #555; margin: 10px; padding: 10px; background: #fff; color: #000; }
    .qrcode { margin-top: 10px; display:flex; gap:15px; flex-wrap:wrap; }
    header {
      position:fixed; top:0; left:0; width:100%;
      background:#000; border-bottom:2px solid #0f0;
      z-index:1000; padding:10px 0;
    }
    header h1 { margin:0; font-size:2.5rem; color:#0f0; text-shadow:0 0 10px #0f0; }
    .header-top { display:flex; justify-content:center; align-items:center; gap:40px; }
    .header-bottom { margin-top:10px; text-align:center; font-size:18px; font-weight:bold; color:#0f0; }
  </style>
</head>
<body>

  <!-- üåü Header fixe -->
  <header>
    <div class="header-top">
      <img src="mwollowm-marche.gif" alt="Animation MWOLLOWM" style="height:100px;">
      <h1>/v/O:O\v\ ‚Äì Mineur de Blocs</h1>
      <img src="mwollowm-marche.gif" alt="Animation MWOLLOWM" style="height:100px;">
    </div>

    <div id="bannerCours" class="header-bottom">
      1 Mwal ‚âà -- ‚Ç¨ 
      | üåç <span style="color:#0ff;">Cumulative Balance = 0 ‚Ç¨</span> 
      | ‚õèÔ∏è <span style="color:#ff9800;">0 blocs</span> 
      | üìä <span id="evolutionMwal" style="color:#aaa;">0%</span>
      | <canvas id="sparkline" width="120" height="30"></canvas>
    </div>
  </header>

  <!-- Formulaire -->
  <div class="form">
    <h2>Ajouter un √©change (Nouveau bloc)</h2>
    <label>Nom du donneur :</label><input type="text" id="donneur" required>
    <label>Nom du receveur :</label><input type="text" id="receveur" required>
    <label>Montant en Mwal :</label><input type="number" id="mwal" step="0.00000001" required>
    <label>Valeur en Euro (‚Ç¨) :</label><input type="number" id="euro" step="0.000000000000000001" required>
    <label>Description :</label><input type="text" id="desc">

    <label>Token (Base64) :</label><input type="text" id="tokenBase64" required>
    <label>DATA :</label><input type="text" id="dataField" required>
    <label>NA1C142 :</label><input type="text" id="na1c142" required>
    <label>Base64 (2) :</label><input type="text" id="base642" required>

    <button class="btn-enregistrer" onclick="ajouterContrat()">‚õèÔ∏è Miner Bloc</button>
    <button class="btn-reset" onclick="resetRegistre()">R√©initialiser Local</button>
  </div>

  <!-- Historique -->
  <div class="history">
    <h2>Historique des √©changes</h2>
    <div id="historique"></div>
  </div>

  <!-- Valeur moyenne -->
  <div class="history">
    <h2>Valeur moyenne du Mwal</h2>
    <p id="moyenne">En attente de donn√©es...</p>
    <small id="moyenneConvertie">--</small>
  </div>

  <!-- Graphique -->
  <div class="history">
    <h2>√âvolution du Mwal</h2>
    <canvas id="chartMwal"></canvas>
    <button onclick="resetZoom()">üîÑ R√©initialiser le zoom</button>
    <button class="btn-export" onclick="exportCSV()">üìÑ Exporter CSV</button>
    <button class="btn-export-pdf" onclick="exportPDF()">üìë Exporter PDF</button>
  </div>

<script>
  // Connexion au serveur Render GUN
  const gun = Gun(["https://validateur-luth.onrender.com/gun"]);

  let contrats = JSON.parse(localStorage.getItem("contratsMwal")) || [];
  let labels = [], valeurs = [], volumes = [];
  let dernierCoursMwal = null;
  const MIN_PUISSANCE = 0.00000694444444444444;
  let cumulativeBalance = 0;

  function decodeBase64Token(tokenB64) {
    try { let decoded = atob(tokenB64); let [valeur, id] = decoded.split("_"); return { valeur, id }; }
    catch (e) { return null; }
  }

  async function ajouterContrat() {
    let donneur = document.getElementById("donneur").value.trim();
    let receveur = document.getElementById("receveur").value.trim();
    let mwal = parseFloat(document.getElementById("mwal").value);
    let euro = parseFloat(document.getElementById("euro").value);
    let desc = document.getElementById("desc").value.trim();
    let tokenBase64 = document.getElementById("tokenBase64").value.trim();
    let dataField = document.getElementById("dataField").value.trim();
    let na1c142 = document.getElementById("na1c142").value.trim();
    let base642 = document.getElementById("base642").value.trim();

    if (!donneur || !receveur || isNaN(mwal) || isNaN(euro) || !tokenBase64 || !dataField || !na1c142 || !base642) {
      alert("Tous les champs obligatoires doivent √™tre remplis !");
      return;
    }

    let tokenInfo = decodeBase64Token(tokenBase64);
    if (!tokenInfo) { alert("Token Base64 invalide !"); return; }
    if (contrats.some(c => c.tokenBase64 === tokenBase64)) {
      alert("Ce token a d√©j√† √©t√© utilis√© !");
      return;
    }

    let puissanceToken = parseFloat(tokenInfo.valeur) || 0;
    cumulativeBalance += puissanceToken;
    let montantMinRequis = Math.max(MIN_PUISSANCE, cumulativeBalance);
    if (euro < montantMinRequis) {
      alert(`Montant trop faible !\nMinimum requis : ${montantMinRequis.toFixed(20)} ‚Ç¨`);
      cumulativeBalance -= puissanceToken; 
      return;
    }

    let contrat = { 
      date: new Date().toLocaleString(), donneur, receveur, mwal, euro, desc,
      tokenBase64, tokenValeur: tokenInfo.valeur, tokenID: tokenInfo.id,
      dataField, na1c142, base642
    };

    contrat.hashBloc = await calculerHash(contrat);

    // Ajout local
    contrats.push(contrat);
    localStorage.setItem("contratsMwal", JSON.stringify(contrats));

    // Affichage + synchro
    afficherContrats(); majGraphique(); majBanniere(); majSparkline();
    gun.get("blocs").set(contrat);
  }

  async function afficherContrats() {
    let historiqueDiv = document.getElementById("historique");
    historiqueDiv.innerHTML = "";
    let cumulCourant = 0;

    contrats.forEach(c => {
      let puissance = parseFloat(c.tokenValeur) || 0;
      cumulCourant += puissance;

      let bloc = document.createElement("div");
      bloc.className = "contrat";
      bloc.innerHTML = `<b>${c.date}</b><br>
        ${c.donneur} ‚Üí ${c.receveur}<br>
        ${c.mwal} Mwal = ${c.euro}‚Ç¨<br>
        ${c.desc}<br>
        Token ID: ${c.tokenID}<br>
        Puissance: ${c.tokenValeur}<br>
        DATA: ${c.dataField}<br>
        NA1C142: ${c.na1c142}<br>
        Base64(2): ${c.base642}<br>
        <small>Hash Bloc : ${c.hashBloc}</small><br>
        <b style="color:green">Contribution sociale : +${puissance.toFixed(20)} ‚Ç¨ (cumulative balance = ${cumulCourant.toFixed(20)} ‚Ç¨)</b>`;

      let qrDiv = document.createElement("div");
      qrDiv.className = "qrcode";
      ["hashBloc","tokenBase64","na1c142","base642"].forEach(k => {
        let qr = document.createElement("div");
        new QRCode(qr, { text: c[k], width: 100, height: 100 });
        qrDiv.appendChild(qr);
      });
      bloc.appendChild(qrDiv);
      historiqueDiv.appendChild(bloc);
    });
  }

  async function calculerHash(contrat) {
    let data = `${contrat.date}|${contrat.donneur}|${contrat.receveur}|${contrat.mwal}|${contrat.euro}|${contrat.desc}|${contrat.tokenBase64}|${contrat.dataField}|${contrat.na1c142}|${contrat.base642}`;
    let encoder = new TextEncoder();
    let hashBuffer = await crypto.subtle.digest("SHA-256", encoder.encode(data));
    return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, "0")).join("");
  }

  function majGraphique() {
    let totalMwal = 0, totalEuro = 0;
    labels.length = valeurs.length = volumes.length = 0;
    contrats.forEach(c => {
      totalMwal += parseFloat(c.mwal) || 0;
      totalEuro += parseFloat(c.euro) || 0;
      if (totalMwal > 0) {
        let valeurMwal = totalEuro / totalMwal;
        dernierCoursMwal = valeurMwal;
        labels.push("Bloc " + (labels.length + 1));
        valeurs.push(valeurMwal.toFixed(4));
        volumes.push(totalMwal.toFixed(8));
        document.getElementById("moyenne").textContent = `1 Mwal ‚âà ${valeurMwal.toFixed(4)} ‚Ç¨`;
        document.getElementById("moyenneConvertie").textContent = `‚âà ${(valeurMwal * 1.08).toFixed(4)} $`;
      }
    });
    chart.update();
  }

  function majBanniere() {
    let cumul = 0; contrats.forEach(c => { cumul += parseFloat(c.tokenValeur) || 0; });
    let nbBlocs = contrats.length;
    let coursTxt = dernierCoursMwal ? `1 Mwal ‚âà ${dernierCoursMwal.toFixed(4)} ‚Ç¨` : `1 Mwal ‚âà -- ‚Ç¨`;

    let evolutionTxt = "--"; let evolutionColor = "#aaa";
    if (valeurs.length >= 2) {
      let prev = parseFloat(valeurs[valeurs.length - 2]);
      let last = parseFloat(valeurs[valeurs.length - 1]);
      if (prev > 0) {
        let evolution = ((last - prev) / prev) * 100;
        evolutionTxt = `${evolution.toFixed(2)}%`;
        if (evolution > 0) evolutionColor = "#0f0";
        else if (evolution < 0) evolutionColor = "#f00";
      }
    }

    document.getElementById("bannerCours").innerHTML =
      `${coursTxt} | üåç <span style="color:#0ff;">Cumulative Balance = ${cumul.toFixed(20)} ‚Ç¨</span> | ‚õèÔ∏è <span style="color:#ff9800;">${nbBlocs} blocs</span> | üìä <span style="color:${evolutionColor};">${evolutionTxt}</span> | <canvas id="sparkline" width="120" height="30"></canvas>`;
    setTimeout(majSparkline, 100);
  }

  function resetRegistre() {
    if (confirm("Effacer l‚Äôhistorique local ?")) {
      localStorage.removeItem("contratsMwal");
      contrats = []; cumulativeBalance = 0;
      afficherContrats(); majGraphique(); majBanniere(); majSparkline();
    }
  }

  const ctx = document.getElementById('chartMwal').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: { labels: labels, datasets: [
      { label: 'Valeur 1 Mwal en ‚Ç¨', data: valeurs, borderColor: '#0f0',
        backgroundColor: 'rgba(0,255,0,0.2)', tension: 0.2, fill: true, yAxisID: 'y' },
      { label: 'Volume total √©chang√© (Mwal)', data: volumes, borderColor: '#00f',
        backgroundColor: 'rgba(0,0,255,0.2)', tension: 0.2, fill: true, yAxisID: 'y1' }
    ]},
    options: { responsive: true, interaction: { mode: 'index', intersect: false },
      stacked: false, scales: { 
        x: { title: { display: true, text: 'Bloc' } },
        y: { type: 'linear', position: 'left', title: { display: true, text: '‚Ç¨ par Mwal' } },
        y1: { type: 'linear', position: 'right', title: { display: true, text: 'Volume total Mwal' }, grid: { drawOnChartArea: false } }
      },
      plugins: { zoom: { pan: { enabled: true, mode: 'xy' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' } } }
    }
  });

  function majSparkline() {
    const ctxSpark = document.getElementById('sparkline').getContext('2d');
    new Chart(ctxSpark, {
      type: 'line',
      data: { labels: labels.slice(-20), datasets: [{
        data: valeurs.slice(-20), borderColor: '#0ff',
        borderWidth: 2, fill: false, pointRadius: 0, tension: 0.3
      }]},
      options: {
        responsive: false,
        plugins: { legend: { display: false },
          tooltip: { enabled: true, mode: 'nearest',
            callbacks: { label: ctx => `1 Mwal = ${parseFloat(ctx.raw).toFixed(6)} ‚Ç¨` } } },
        interaction: { mode: 'nearest', intersect: false },
        scales: { x: { display: false }, y: { display: false } }
      }
    });
  }

  function exportCSV() {
    if (contrats.length === 0) { alert("Aucun bloc √† exporter"); return; }
    let csv = "Date,Donneur,Receveur,Mwal,Euro,TokenID,Puissance,DATA,NA1C142,Base64(2),HashBloc\n";
    contrats.forEach(c => {
      csv += `"${c.date}","${c.donneur}","${c.receveur}",${c.mwal},${c.euro},"${c.tokenID}",${c.tokenValeur},"${c.dataField}","${c.na1c142}","${c.base642}","${c.hashBloc}"\n`;
    });
    let blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "blocs_mwal.csv";
    link.click();
  }

  // Export PDF officiel
  async function exportPDF() {
    if (contrats.length === 0) { alert("Aucun bloc √† exporter"); return; }
    const { jsPDF } = window.jspdf;
    let pdf = new jsPDF("p", "mm", "a4");

    // En-t√™te
    pdf.setFontSize(16);
    pdf.setTextColor(0, 128, 0);
    pdf.text("Projet LUTH ‚Äì Registre des Blocs", 105, 15, { align: "center" });
    pdf.setFontSize(10);
    pdf.setTextColor(100);
    pdf.text(`Date d'export : ${new Date().toLocaleString()}`, 105, 22, { align: "center" });

    // Bilan global
    let cumul = 0; contrats.forEach(c => { cumul += parseFloat(c.tokenValeur) || 0; });
    let nbBlocs = contrats.length;
    let coursTxt = dernierCoursMwal ? `${dernierCoursMwal.toFixed(4)} ‚Ç¨` : "-- ‚Ç¨";

    let evolutionTxt = "--";
    if (valeurs.length >= 2) {
      let prev = parseFloat(valeurs[valeurs.length - 2]);
      let last = parseFloat(valeurs[valeurs.length - 1]);
      if (prev > 0) {
        let evolution = ((last - prev) / prev) * 100;
        evolutionTxt = `${evolution.toFixed(2)} %`;
      }
    }

    pdf.setFontSize(12);
    pdf.setTextColor(0);
    pdf.text(`üìà Cours du Mwal : ${coursTxt}`, 20, 35);
    pdf.text(`üåç Cumulative Balance : ${cumul.toFixed(20)} ‚Ç¨`, 20, 42);
    pdf.text(`‚õèÔ∏è Nombre de blocs : ${nbBlocs}`, 20, 49);
    pdf.text(`üìä √âvolution : ${evolutionTxt}`, 20, 56);

    // Sparkline dans le PDF
    try {
      let sparkCanvas = document.getElementById("sparkline");
      if (sparkCanvas) {
        let sparkImg = sparkCanvas.toDataURL("image/png");
        pdf.addImage(sparkImg, "PNG", 140, 35, 50, 20); 
      }
    } catch (e) { console.warn("Sparkline non dispo :", e); }

    // Capture de l‚Äôhistorique
    let historiqueDiv = document.getElementById("historique");
    let canvas = await html2canvas(historiqueDiv, { scale: 2 });
    let imgData = canvas.toDataURL("image/png");

    let imgWidth = 190;
    let pageHeight = 295;
    let imgHeight = canvas.height * imgWidth / canvas.width;
    let heightLeft = imgHeight;
    let position = 65;

    pdf.addImage(imgData, "PNG", 10, position, imgWidth, imgHeight);
    heightLeft -= (pageHeight - position);

    while (heightLeft > 0) {
      position = 30;
      pdf.addPage();
      pdf.addImage(imgData, "PNG", 10, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }

    // Pagination
    let pageCount = pdf.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      pdf.setPage(i);
      pdf.setFontSize(9);
      pdf.setTextColor(150);
      pdf.text(`Page ${i} / ${pageCount}`, 200, 290, { align: "right" });
    }

    pdf.save("registre_blocs_LUTH.pdf");
  }

  // --- SYNCHRO TEMPS R√âEL AVEC GUN ---
  gun.get("blocs").map().on(async (contrat, id) => {
    if (!contrat) return;
    if (!contrats.find(c => c.hashBloc === contrat.hashBloc)) {
      contrats.push(contrat);
      localStorage.setItem("contratsMwal", JSON.stringify(contrats));
      afficherContrats(); majGraphique(); majBanniere(); majSparkline();
    }
  });

  // Init
  afficherContrats();
  majGraphique();
  majBanniere();
  majSparkline();
</script>
</body>
</html>
